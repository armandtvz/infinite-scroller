"use strict";const scroller_utils={required_arg:function e(t){const r=new Error(`Required argument missing (${t})`);throw Error.captureStackTrace(r,e),r}};class ScrollerConfigError extends Error{constructor(e=scroller_utils.required_arg("message")){super(e),this.name="ScrollerConfigError"}}function Scroller({scroller_id:e=scroller_utils.required_arg("scroller_id"),get_url_func:t=scroller_utils.required_arg("get_url_func"),process_json_to_html_func:r,sentinel_id:o="sentinel",start_page_number:n=1,loader_id:s=scroller_utils.required_arg("loader_id"),button_id:i,preload:c=!1,threshold_factor:l=.4,threshold:a,max_retries:u=10,max_backoff_ms:d=2e4}){if(!new.target)throw new TypeError("Object cannot be created without the new keyword");let _=n,f=!1,h=!1;const m=document.getElementById(e),p=document.getElementById(o),g=document.getElementById(s);let w=void 0;i?w=document.getElementById(i):E(),function(){const e="could not be found. Check the config.";if(!m)throw new ScrollerConfigError("Scroller element "+e);if(!p)throw new ScrollerConfigError("Sentinel element "+e);if(!g)throw new ScrollerConfigError("Loader element "+e);if(i&&!w)throw new ScrollerConfigError("Load more button "+e)}(),i&&w.addEventListener("click",e=>{e.preventDefault(),b()});let y=0;function v({url:e=scroller_utils.required_arg("url"),method:t="get",success_callback:r=scroller_utils.required_arg("success_callback"),error_callback:o,response_type:n}){const s=new XMLHttpRequest;function i(e,t){return Math.floor(Math.random()*(t-e+1))+e}function c(){let e=20**y;return e=i(0,Math.min(e,d)),e<100&&(e+=i(100,200)),e}function l(){return{status:s.status,data:s.response,content_type:s.getResponseHeader("Content-Type"),retries_exhausted:void 0,retry_too_far_in_future:void 0,was_error:void 0}}function a(i){!function(){let i=0;if(y<u){if(y+=1,i=s.getResponseHeader("Retry-After"),i){const e=parseInt(i);if(isNaN(e)?(i=Date.parse(i),i-=Date.now()):i=Math.ceil(1e3*e),i>72e5){const e=l();return void(o&&(e.retry_too_far_in_future=!0,o(e)))}i<0&&(i=c())}else i=c();console.info("Attempt to fetch new content failed. Will retry after "+i.toString()+" milliseconds."),setTimeout(()=>{console.info("Starting retry attempt "+y+"..."),v({url:e,method:t,success_callback:r,error_callback:o,response_type:n}),console.info("Retried.")},i)}else{console.info("Request for new content failed.");const e=l();o&&(u>0&&(console.info("Maximum retries reached."),e.retries_exhausted=!0),e.was_error=!0,o(e))}}()}s.addEventListener("load",(function(e){if(s.status>=200&&s.status<400){const e=l();r(e)}else if(s.status>=500||429===s.status)a(e);else if(o){const e=l();e.was_error=!0,o(e)}}),{once:!0}),s.addEventListener("error",a,{once:!0}),s.open(t,e),s.setRequestHeader("HTTP_X_REQUESTED_WITH","XMLHttpRequest"),s.setRequestHeader("X-Requested-With","XMLHttpRequest"),n&&(s.responseType=n),s.send()}function E(){document.addEventListener("scroll",b,{passive:!0}),h=!0}function b(){if(f)return!1;i||!1!==h||E();const e=window.innerHeight||document.documentElement.clientHeight,t=p.getBoundingClientRect().top;return null==a&&(a=e*l),!!(t>=e&&t<=e+a||t>=0&&t<=e)&&(k(),!0)}function S({forever:e=!1}={forever:!1}){f=!1,g.style.opacity="0",g.setAttribute("hidden",""),m.hasAttribute("aria-busy")&&m.setAttribute("aria-busy","false"),e&&(g.style.display="none")}function k(e){f=!0,g.style.opacity="1",g.removeAttribute("hidden"),m.hasAttribute("aria-busy")&&m.setAttribute("aria-busy","true");const o=t(_);let n=void 0;if(!e){let e=void 0;return r&&(e="json"),void v({url:o,method:"get",success_callback:k,error_callback:q,response_type:e})}if(204===e.status)R(e);else{if("application/json"!==e.content_type&&r)throw new ScrollerConfigError("You should not be providing a process_json_to_html_func callback because the server is not returning JSON. Remove the callback from the config.");if("application/json"===e.content_type){if(!r)throw new ScrollerConfigError("You must provide a process_json_to_html_func callback because the server is returning JSON.");n=r(e.data)}else n=e.data;n?(!function(e){let t=void 0;if(r&&Array.isArray(e))t=e;else{const r=document.createElement("div");r.innerHTML=e,t=r.children,t=Array.from(t)}t.forEach((e,t)=>{m.appendChild(e)});const o=new CustomEvent("scroller_updated",{detail:{new_elements:t}});document.dispatchEvent(o),S()}(n),_+=1):R(e)}}function q(e){(e.retries_exhausted||e.retry_too_far_in_future||e.was_error)&&R(e)}function R(e){S({forever:!0}),document.removeEventListener("scroll",b,{passive:!0}),h=!1;const t=new CustomEvent("scroller_end",{detail:{http_status:e.status,retries_exhausted:e.retries_exhausted,retry_too_far_in_future:e.retry_too_far_in_future,was_error:e.was_error}});document.dispatchEvent(t)}c&&k()}